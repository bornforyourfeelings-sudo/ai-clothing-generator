<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No One Else Has This</title>
    <style>
        /* --- СТИЛИ БЕЗ ИЗМЕНЕНИЙ --- */
        body {font-family:Arial;background:#000;color:#fff;text-align:center;padding:30px;}
        h1 {font-size:2.8em;background:linear-gradient(90deg,#ff00aa,#00ffff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        input[type=text],select {width:90%;max-width:600px;padding:18px;margin:10px;font-size:1.4em;border:3px solid #ff00aa;border-radius:15px;background:#111;color:white;}
        input[type=submit] {padding:18px 60px;font-size:1.6em;background:#ff00aa;border:none;border-radius:50px;cursor:pointer;color:white;font-weight:bold; transition: 0.3s;}
        input[type=submit]:disabled {background:#555;cursor:wait;color:#aaa;border:3px solid #555;}
        input[type=submit]:hover:not(:disabled) {box-shadow: 0 0 15px #ff00aa;}
        
        .result {margin:60px auto;max-width:600px; display: none;} 
        img {width:100%;border-radius:20px;margin:20px 0;box-shadow:0 0 40px #ff00aa88; min-height: 200px; object-fit: contain; background: #222;} 
        button {margin:15px 0;padding:16px;width:100%;font-size:1.3em;border:none;border-radius:40px;cursor:pointer;}
        .produce {background:#25d366;color:white;font-weight:bold; transition: 0.3s;}
        .produce:hover {box-shadow: 0 0 20px #25d366;}
        
        /* Лоадер */
        .loader {display:none; border: 5px solid #222; border-top: 5px solid #ff00aa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto;}
        @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
        
        /* Блок информации/ошибки */
        .info-container {display: none; background: #333; border: 2px solid #555; padding: 15px; border-radius: 10px; margin: 20px auto; max-width: 600px;}
        .info-container.error {background: #3a0000; border-color: #ff0000;}
        .info-container.warning {background: #aa6600; border-color: #ffcc00;}
        .info-msg {color: #ccc; margin: 0; font-weight: bold;}
        .info-container.error .info-msg {color: #ff5555;}
        .info-container.warning .info-msg {color: #ffddaa;}
    </style>
</head>
<body>

    <h1>No One Else Has This</h1>
    <p>Describe your dream clothing — China makes it real</p>

    <form id="appForm">
        <input type="text" id="prompt" placeholder="Describe your dream clothing..." required>
        <select id="size">
            <option>XS</option>
            <option>S</option>
            <option selected>M</option>
            <option>L</option>
            <option>XL</option>
            <option>XXL</option>
        </select>
        <input type="text" id="qty" placeholder="Quantity" value="1">
        <input type="submit" id="submitBtn" value="Generate">
    </form>
    
    <div class="loader" id="loader"></div>

    <div class="info-container" id="infoBlock">
        <p class="info-msg" id="infoMessage"></p>
    </div>

    <div class="result" id="resultBlock">
        <img id="resultImg" src="" alt="Generated Image">
        <button class="produce" id="waButton"> Produce in China — $32–48 </button>
    </div>

    <script>
        const FACTORY_WHATSAPP = "8613980632981"; 
        const YOUR_REFERRAL_CODE = "REF_GROK2025";
        // Заглушка, если API временно недоступен (чтобы не было пустой картинки)
        const FALLBACK_IMAGE_PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1024' height='1024' viewBox='0 0 1024 1024'%3E%3Crect width='100%25' height='100%25' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='60' fill='%23ccc' text-anchor='middle' alignment-baseline='middle'%3EImage Unavailable%3C/text%3E%3C/svg%3E";

        let currentGenerationPrompt = ""; // Для повторных попыток

        document.getElementById('appForm').addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            currentGenerationPrompt = document.getElementById('prompt').value; // Сохраняем запрос
            const sizeVal = document.getElementById('size').value;
            const qtyVal = document.getElementById('qty').value;
            
            const imgElement = document.getElementById('resultImg');
            const resultDiv = document.getElementById('resultBlock');
            const loader = document.getElementById('loader');
            const btn = document.getElementById('submitBtn');
            const infoBlock = document.getElementById('infoBlock');
            const infoMessage = document.getElementById('infoMessage');

            // Сброс интерфейса в состояние "Загрузка"
            btn.value = "Dreaming...";
            btn.disabled = true;
            loader.style.display = "block";
            resultDiv.style.display = "none";
            infoBlock.style.display = "none";
            infoBlock.classList.remove('error', 'warning'); // Сброс классов цвета
            imgElement.src = ""; // Очищаем картинку для новой генерации

            generateImage(currentGenerationPrompt, sizeVal, qtyVal, imgElement, resultDiv, loader, btn, infoBlock, infoMessage, 0); // Начинаем попытки генерации
        });

        // Функция для попыток генерации
        function generateImage(prompt, size, qty, imgElement, resultDiv, loader, btn, infoBlock, infoMessage, attempt) {
            const MAX_ATTEMPTS = 2; // Максимум попыток генерации
            const RETRY_DELAY_MS = 5000; // Задержка между попытками

            // Генерация уникального ключа (seed) для каждой попытки
            const seed = Math.floor(Math.random() * 2000000);
            
            // Упрощенный запрос для стабильности
            const basePrompt = encodeURIComponent(`${prompt}, fashion product photo, white background, studio lighting`); // Убрал "ultra detailed, 8k"
            
            const imageUrl = `https://pollinations.ai/p/${basePrompt}?width=1024&height=1024&model=flux&nologo=true&seed=${seed}`;

            console.log(`Attempt ${attempt + 1}: Loading image from ${imageUrl}`);

            let generationTimeout; // Переменная для таймаута

            // Устанавливаем обработчики
            imgElement.onload = function() {
                clearTimeout(generationTimeout); // Отменяем таймаут, если загрузка успешна
                loader.style.display = "none";
                resultDiv.style.display = "block";
                btn.value = "Generate";
                btn.disabled = false;
                
                // Обновляем ссылку WhatsApp
                updateWhatsappLink(prompt, size, qty, imageUrl);
            };

            imgElement.onerror = function() {
                clearTimeout(generationTimeout); // Отменяем таймаут
                console.error(`Attempt ${attempt + 1}: Image failed to load.`);
                
                if (attempt < MAX_ATTEMPTS - 1) {
                    // Если есть еще попытки, пробуем снова
                    infoBlock.style.display = "block";
                    infoBlock.classList.add('warning');
                    infoMessage.textContent = `Image generation failed. Retrying in ${RETRY_DELAY_MS / 1000} seconds... (Attempt ${attempt + 1}/${MAX_ATTEMPTS})`;
                    
                    loader.style.display = "block"; // Держим лоадер
                    btn.value = "Retrying...";
                    btn.disabled = true;

                    setTimeout(() => {
                        generateImage(prompt, size, qty, imgElement, resultDiv, loader, btn, infoBlock, infoMessage, attempt + 1);
                    }, RETRY_DELAY_MS);
                } else {
                    // Если попытки закончились
                    loader.style.display = "none";
                    infoBlock.style.display = "block";
                    infoBlock.classList.add('error');
                    infoMessage.textContent = "⚠️ All image generation attempts failed. The API might be overloaded. You can still order by describing your design in WhatsApp!";
                    btn.value = "Try Again";
                    btn.disabled = false;
                    imgElement.src = FALLBACK_IMAGE_PLACEHOLDER; // Показываем заглушку
                    resultDiv.style.display = "block"; // Показываем блок с кнопкой Produce
                    // Обновляем ссылку WhatsApp (только с описанием)
                    updateWhatsappLink(prompt, size, qty, `Description: ${prompt}`);
                }
            };

            // Запускаем таймер, если картинка не загрузится
            generationTimeout = setTimeout(() => {
                console.warn(`Attempt ${attempt + 1}: Image generation timed out.`);
                imgElement.onerror(); // Вызываем обработчик ошибки вручную
            }, 35000); // 35 секунд на генерацию

            imgElement.src = imageUrl; // Запускаем загрузку
        }

        // Обновление ссылки WhatsApp
        function updateWhatsappLink(prompt, size, qty, imageUrlOrDescription) {
            const message = `Hello MMS Clothing!
Fully custom clothing — cut & sew
Referral: ${YOUR_REFERRAL_CODE} → 25% cashback
Design:
${imageUrlOrDescription}
Description: ${prompt}
Size: ${size} | Quantity: ${qty} pc(s)
Please send quote + sample cost + lead time.
Thank you!`;

            const waLink = `https://wa.me/${FACTORY_WHATSAPP}?text=${encodeURIComponent(message)}`;
            document.getElementById('waButton').onclick = () => window.open(waLink, '_blank');
        }
    </script>
</body>
</html>
