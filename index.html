<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No One Else Has This</title>
    <style>
        body {font-family:Arial;background:#000;color:#fff;text-align:center;padding:30px;}
        h1 {font-size:2.8em;background:linear-gradient(90deg,#ff00aa,#00ffff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        input[type=text],select {width:90%;max-width:600px;padding:18px;margin:10px;font-size:1.4em;border:3px solid #ff00aa;border-radius:15px;background:#111;color:white;}
        input[type=submit] {padding:18px 60px;font-size:1.6em;background:#ff00aa;border:none;border-radius:50px;cursor:pointer;color:white;font-weight:bold;}
        .result {margin:60px auto;max-width:600px; display: none;} 
        img {width:100%;border-radius:20px;margin:20px 0;box-shadow:0 0 40px #ff00aa88;}
        button {margin:15px 0;padding:16px;width:100%;font-size:1.3em;border:none;border-radius:40px;cursor:pointer;}
        .produce {background:#25d366;color:white;font-weight:bold;}
        
        /* Лоадер */
        .loader {display:none; border: 5px solid #333; border-top: 5px solid #ff00aa; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto;}
        @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
    </style>
</head>
<body>

    <h1>No One Else Has This</h1>
    <p>Describe your dream clothing — China makes it real</p>

    <form id="appForm">
        <input type="text" id="prompt" name="prompt" placeholder="Describe your dream clothing..." required>
        <select id="size" name="size">
            <option>XS</option>
            <option>S</option>
            <option selected>M</option>
            <option>L</option>
            <option>XL</option>
            <option>XXL</option>
        </select>
        <input type="text" id="qty" name="qty" placeholder="Quantity" value="1">
        <input type="submit" id="submitBtn" value="Generate">
    </form>
    
    <div class="loader" id="loader"></div>

    <div class="result" id="resultBlock">
        <img id="resultImg" src="" alt="Generated Image" referrerpolicy="no-referrer">
        <button class="produce" id="waButton"> Produce in China — $32–48 </button>
    </div>

    <script>
        const FACTORY_WHATSAPP = "8613980632981"; 
        const YOUR_REFERRAL_CODE = "REF_GROK2025";
        
        // Ключ ImgBB
        const IMGBB_KEY = "10b08c5be2b4f6c9a2f1d2e8f7c3e4a5";

        document.getElementById('appForm').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            const promptVal = document.getElementById('prompt').value;
            const sizeVal = document.getElementById('size').value;
            const qtyVal = document.getElementById('qty').value;
            const imgElement = document.getElementById('resultImg');
            const resultDiv = document.getElementById('resultBlock');
            const loader = document.getElementById('loader');
            const btn = document.getElementById('submitBtn');

            // UI Loading state
            btn.value = "Dreaming...";
            btn.disabled = true;
            loader.style.display = "block";
            resultDiv.style.display = "none";

            // Генерация ссылки Pollinations
            const seed = Math.floor(Math.random() * 1000000);
            const cleanPrompt = encodeURIComponent(`${promptVal}, fashion product photo, white background, studio lighting, detailed, high quality`);
            const pollUrl = `https://image.pollinations.ai/prompt/${cleanPrompt}?width=1024&height=1024&seed=${seed}&nologo=true`;

            console.log("Loading URL:", pollUrl);

            // Предзагрузка через fetch с таймаутом
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000);

            try {
                await fetch(pollUrl, { 
                    signal: controller.signal,
                    mode: 'no-cors' 
                });
                clearTimeout(timeoutId);
                
                // Устанавливаем ссылку на картинку
                imgElement.src = pollUrl;
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    console.log('Generation timeout, trying direct load...');
                }
                imgElement.src = pollUrl;
            }

            // Если картинка загрузилась успешно
            imgElement.onload = async function() {
                loader.style.display = "none";
                resultDiv.style.display = "block";
                btn.value = "Generate";
                btn.disabled = false;

                // Сначала готовим финальную ссылку как ссылку генератора (резервный вариант)
                let finalLink = pollUrl;

                // Пытаемся загрузить на ImgBB (в фоне)
                try {
                    const formData = new FormData();
                    formData.append("image", pollUrl);
                    
                    const upload = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    const response = await upload.json();
                    
                    if(response.success) {
                        finalLink = response.data.url;
                    }
                } catch (err) {
                    console.log("ImgBB fail, keeping original link");
                }

                // Формируем ссылку WhatsApp
                const message = `Hello MMS Clothing!
Fully custom clothing — cut & sew
Referral: ${YOUR_REFERRAL_CODE} → 25% cashback
Design:
${finalLink}
Description: ${promptVal}
Size: ${sizeVal} | Quantity: ${qtyVal} pc(s)
Please send quote + sample cost + lead time.
Thank you!`;

                const waLink = `https://wa.me/${FACTORY_WHATSAPP}?text=${encodeURIComponent(message)}`;
                
                document.getElementById('waButton').onclick = () => window.open(waLink, '_blank');
            };

            // Если картинка НЕ загрузилась (ошибка генерации)
            imgElement.onerror = function() {
                loader.style.display = "none";
                btn.value = "Generate";
                btn.disabled = false;
                
                // Пробуем альтернативный сервис
                const alternativeSeed = Math.floor(Math.random() * 1000000);
                const altUrl = `https://image.pollinations.ai/prompt/${cleanPrompt}?width=1024&height=1024&seed=${alternativeSeed}&enhance=true`;
                
                console.log("Trying alternative URL:", altUrl);
                imgElement.src = altUrl;
                
                // Если и альтернатива не сработала
                imgElement.onerror = function() {
                    loader.style.display = "none";
                    alert("Image generation failed. Please try:\n1. Simplify your description\n2. Check internet connection\n3. Try again in a moment");
                };
            };
        });
    </script>
</body>
</html>
