<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No One Else Has This</title>
    <style>
        /* Стили точь-в-точь из вашего Python кода */
        body {font-family:Arial;background:#000;color:#fff;text-align:center;padding:30px;}
        h1 {font-size:2.8em;background:linear-gradient(90deg,#ff00aa,#00ffff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        input[type=text],select {width:90%;max-width:600px;padding:18px;margin:10px;font-size:1.4em;border:3px solid #ff00aa;border-radius:15px;background:#111;color:white;}
        input[type=submit] {padding:18px 60px;font-size:1.6em;background:#ff00aa;border:none;border-radius:50px;cursor:pointer;}
        .result {margin:60px auto;max-width:600px; display: none;} /* Скрыто по умолчанию */
        img {width:100%;border-radius:20px;margin:20px 0;box-shadow:0 0 40px #ff00aa88;}
        button {margin:15px 0;padding:16px;width:100%;font-size:1.3em;border:none;border-radius:40px;cursor:pointer;}
        .produce {background:#25d366;color:white;font-weight:bold;}
    </style>
</head>
<body>

    <h1>No One Else Has This</h1>
    <p>Describe your dream clothing — China makes it real</p>

    <form id="appForm">
        <input type="text" id="prompt" name="prompt" placeholder="Describe your dream clothing..." required>
        <select id="size" name="size">
            <option>XS</option>
            <option>S</option>
            <option selected>M</option>
            <option>L</option>
            <option>XL</option>
            <option>XXL</option>
        </select>
        <input type="text" id="qty" name="qty" placeholder="Quantity" value="1">
        <input type="submit" value="Generate">
    </form>

    <div class="result" id="resultBlock">
        <img id="resultImg" src="" alt="Generated Image">
        <button class="produce" id="waButton"> Produce in China — $32–48 </button>
    </div>

    <script>
        // Константы из вашего Python кода
        const FACTORY_WHATSAPP = "8613980632981"; // + убран для ссылки
        const YOUR_REFERRAL_CODE = "REF_GROK2025";
        const IMGBB_KEY = "10b08c5be2b4f6c9a2f1d2e8f7c3e4a5";

        document.getElementById('appForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Останавливаем перезагрузку страницы

            const prompt = document.getElementById('prompt').value;
            const size = document.getElementById('size').value;
            const qty = document.getElementById('qty').value;

            // 1. Аналог generate_image (Pollinations)
            // Python: encoded_prompt = urllib.parse.quote(...)
            const fullPrompt = `${prompt}, fashion product photo, white background, studio lighting, ultra detailed, 8k`;
            const encodedPrompt = encodeURIComponent(fullPrompt);
            const pollUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?model=flux&width=1024&height=1024`;

            // Для отображения картинки сразу (как в Python коде img_b64)
            // Мы сначала скачиваем её, чтобы потом отправить на ImgBB
            try {
                const response = await fetch(pollUrl);
                const blob = await response.blob(); // Получаем картинку как файл

                // Отображаем картинку пользователю
                const imgUrlLocal = URL.createObjectURL(blob);
                const resultImg = document.getElementById('resultImg');
                resultImg.src = imgUrlLocal;
                document.getElementById('resultBlock').style.display = 'block';

                // 2. Аналог upload_to_imgbb
                // Отправляем полученный blob на ImgBB
                const formData = new FormData();
                formData.append("image", blob);
                
                let finalImgUrl = "";
                
                try {
                    const uploadReq = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadReq.json();
                    if (uploadData.success) {
                        finalImgUrl = uploadData.data.url;
                    } else {
                        // Если ImgBB не сработал, используем ссылку Pollinations (фоллбэк из вашего кода)
                        finalImgUrl = pollUrl; 
                    }
                } catch (err) {
                    finalImgUrl = pollUrl; // Фоллбэк при ошибке сети
                }

                // 3. Аналог generate_whatsapp_link
                const message = `Hello MMS Clothing!
Fully custom clothing — cut & sew
Referral: ${YOUR_REFERRAL_CODE} → 25% cashback
Design:
${finalImgUrl}
Description: ${prompt}
Size: ${size} | Quantity: ${qty} pc(s)
Please send quote + sample cost + lead time.
Thank you!`;

                const waLink = `https://wa.me/${FACTORY_WHATSAPP}?text=${encodeURIComponent(message)}`;
                
                // Привязываем ссылку к кнопке
                document.getElementById('waButton').onclick = function() {
                    window.open(waLink);
                };

            } catch (error) {
                console.error("Error:", error);
                alert("Error generating image");
            }
        });
    </script>
</body>
</html>
